name: Supabase Keepalive

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run keepalive query directly on Supabase
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail

          if [ -z "${DATABASE_URL}" ]; then
            echo "Missing required secret: DATABASE_URL"
            exit 1
          fi

          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 <<'SQL'
          select now();

          do $$
          begin
            if to_regclass('public.system_heartbeats') is not null then
              insert into public.system_heartbeats (source, note)
              values ('github-actions-direct', '');
            end if;
          end
          $$;
          SQL
